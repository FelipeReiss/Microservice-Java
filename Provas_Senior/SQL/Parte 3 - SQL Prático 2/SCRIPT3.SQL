/*
Parte 3 – SQL Prático1
Exercício 3.
Crie uma procedure chamada DEFINIR_VALORES para que altere o valor dos 
itens da tabela EXAME_ITEMNF, definindo números inteiros aleatórios entre 
1 e 100. Faça com que a linha da tabela EXAME_NF receba o valor da somatória 
de seus itens na coluna TOTALGERAL. Salve o fonte do script no arquivo SCRIPT3.SQL.

*/

-- CREATING PROCEDURE
DROP PROCEDURE IF EXISTS DEFINIR_VALORES; -- OBS: LINHA ADICIONADA APENAS PARA MANTER A CONSISTÊNCIA DOS DADOS NESTE EXERCÍCIO, ENTENDO O RISCO DE SE DELETAR UMA PROCEDURE EM PRODUÇÃO
DELIMITER //
CREATE PROCEDURE DEFINIR_VALORES ()
BEGIN

-- VARIABLES
DECLARE LIMITE_MENOR INT DEFAULT 1;
DECLARE LIMITE_MAIOR INT DEFAULT 100;

-- UPDATING NEW RANDOM "VALOR"
UPDATE EXAME_ITEMNF SET VALOR = (ROUND(RAND() * (LIMITE_MAIOR - LIMITE_MENOR) + LIMITE_MENOR, 0));

-- CREATING VIEW WITH NEW "TOTALGERAL" TO UPDATE "TOTALGERAL" LATER
DROP VIEW IF EXISTS QTD_ITEMNF;
CREATE VIEW QTD_ITEMNF AS 
SELECT I.IDNF, COUNT(*) AS `TOTALGERAL` 
FROM EXAME_NF AS N, EXAME_ITEMNF AS I 
WHERE I.IDNF=N.IDNF 
GROUP BY I.IDNF;

-- UPDATING NEW "TOTALGERAL"
UPDATE EXAME_NF AS N INNER JOIN QTD_ITEMNF AS Q ON N.IDNF = Q.IDNF SET N.TOTALGERAL = Q.TOTALGERAL;
DROP VIEW IF EXISTS QTD_ITEMNF;

END
//
DELIMITER ;

-- Test
SELECT * FROM EXAME_NF;
SELECT * FROM EXAME_ITEMNF;
CALL DEFINIR_VALORES();
SELECT * FROM EXAME_ITEMNF;
SELECT * FROM EXAME_NF;