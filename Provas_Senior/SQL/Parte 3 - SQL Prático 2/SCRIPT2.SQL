/*
Parte 3 – SQL Prático1
Exercício 2.
Crie um segundo script (SCRIPT2.SQL) que possua um bloco de código para que gere 
registros fictícios para as tabelas criadas. Gere 1000 registros para a tabela 
EXAME_NF. Para cada EXAME_NF gere 3 registros. Faça com que a DATACADASTRO do 
EXAME_NF comece em 10 dias atrás, fazendo com que a cada 100 registros a data 
seja aumentada em 1 dia, distribuindo assim os 1000 registros em 10 dias 
diferentes de cadastro.

*/

-- CREATING PROCEDURE
DROP PROCEDURE IF EXISTS NOVOS_EXAMES; -- OBS: LINHA ADICIONADA APENAS PARA MANTER A CONSISTÊNCIA DOS DADOS NESTE EXERCÍCIO, ENTENDO O RISCO DE SE DELETAR UMA PROCEDURE EM PRODUÇÃO
DELIMITER //
CREATE PROCEDURE NOVOS_EXAMES (QTD INT)
BEGIN
	-- VARIABLES
    DECLARE CONT_EXAME INT DEFAULT 0;
	DECLARE CONT_ITEMNF INT DEFAULT 3;
    
    DECLARE NUMERO INT DEFAULT 0;
	DECLARE TOTALGERAL INT DEFAULT 0;
    DECLARE EXAME_DATA DATE;
    
    DECLARE IDPRODUTO INT DEFAULT 0;
    DECLARE QTDE INT DEFAULT 0;
    DECLARE VALOR FLOAT DEFAULT 0;
    DECLARE IDNF INT DEFAULT 0;
        
    -- SETTING DATE VALUES
	SET EXAME_DATA = DATE_SUB(CURDATE(), INTERVAL 10 DAY);
    
    -- LOOP TO INSERT NEW VALUES
    WHILE QTD != 0 
	DO
		-- SETTING NEW VALUES
        IF CONT_EXAME % 100 = 0 THEN
			SET EXAME_DATA = DATE_ADD(EXAME_DATA, INTERVAL 1 DAY);
        END IF;
		SET CONT_EXAME = CONT_EXAME + 1;
        SET NUMERO = FLOOR(RAND() * 1000);
		SET TOTALGERAL = FLOOR(RAND() * 1000);
        SET IDNF = QTD;
        
        -- INSERT NEW EXAME
		INSERT INTO EXAME_NF (IDNF, NUMERO, DATACADASTRO, TOTALGERAL) VALUES (IDNF, NUMERO, EXAME_DATA, TOTALGERAL);
        
        -- LOOP TO INSERT NEW NF ITEM
        WHILE CONT_ITEMNF != 0 
		DO
			-- SETTING NEW VALUES
			SET IDPRODUTO = FLOOR(RAND() * 1000);
			SET QTDE = FLOOR(RAND() * 1000);
			SET VALOR = ROUND(RAND() * 1000, 2);
			
            -- INSERT NEW NF ITEM
			INSERT INTO EXAME_ITEMNF (IDPRODUTO, QTDE, VALOR, IDNF) VALUES (IDPRODUTO, QTDE, VALOR, IDNF);
            SET CONT_ITEMNF = CONT_ITEMNF - 1;
        END WHILE;
        SET CONT_ITEMNF = 3;
        SET IDNF = 0;
        
        SET QTD = QTD - 1;
	END WHILE;

END
//
DELIMITER ;

-- Test
SELECT * FROM EXAME_ITEMNF;
SELECT * FROM EXAME_NF;
CALL NOVOS_EXAMES(1000);
SELECT * FROM EXAME_ITEMNF;
SELECT * FROM EXAME_NF;